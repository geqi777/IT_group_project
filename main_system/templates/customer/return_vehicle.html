{% extends "customer_layout.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <!-- Back按钮蓝底白字 -->
    <div class="d-flex align-items-center mb-4">
        <a href="javascript:history.back()" class="btn btn-primary" style="color: #fff; background-color: #007bff; border: none;">&larr; Back</a>
    </div>

    <!-- 信息模块 -->
    <div class="card mb-4 p-4 shadow-sm border-0" style="background-color: #f9fcff;">
        <h2 class="text-left" style="color: #007bff;"><i class="fas fa-info-circle"></i> Trip Summary</h2>
        <div class="trip-details mt-3" style="text-align: left;">
            <p><strong>Start Time:</strong> {{ start_time }}</p>
            <p><strong>End Time:</strong> {{ end_time }}</p>
            <p><strong>Start Location:</strong> {{ start_location }}</p>
            <p><strong>End Location:</strong> {{ end_location }}</p>
            <p><strong>Total Distance:</strong> {{ distance }}</p>
            <p><strong>Total Time Spent:</strong> {{ rental_duration }}</p>

            <h3 style="font-size: 1.8rem; color: #007bff;">
                <strong>Rental Cost:</strong>
                <span id="rental_cost_display">
                    £<span id="rental_cost">{{ rental_cost }}</span>
                </span>
            </h3>
            <p><strong>Points Earned:</strong> {{ points_earned }}</p>
            <p><strong>Wallet Balance:</strong> £{{ new_balance }}</p>

        </div>
    </div>

    <!-- Rating module with default 5-star selection -->
    <div class="card mb-4 p-4 shadow-sm border-0" style="background-color: #eef7ff;">
        <h3 class="text-left" style="color: #007bff;"><i class="fas fa-star"></i> Rate This Vehicle</h3>
        <div class="form-group mt-3" style="text-align: left;">
            <div class="rating-stars" id="ratingStars" style="font-size: 2.5rem;">
                <span class="star selected" data-value="1">&#9733;</span>
                <span class="star selected" data-value="2">&#9733;</span>
                <span class="star selected" data-value="3">&#9733;</span>
                <span class="star selected" data-value="4">&#9733;</span>
                <span class="star selected" data-value="5">&#9733;</span>
            </div>
            <input type="hidden" id="rating" name="rating" value="5">
            <small class="text-muted">Click on the stars to rate (1-5).</small>
        </div>
    </div>

    <!-- Coupon selection -->
    <div id="coupon-list" class="d-flex flex-wrap justify-content-start mt-3">
        <!-- No Coupon option -->
        <div class="coupon-item card text-center p-4 m-2" id="no-coupon" data-coupon-id="" data-discount="0"
             style="width: 12rem; height: auto; display: flex; align-items: center; justify-content: center;
                    border: 1px solid #007bff; background-color: #f9fcff; border-radius: 10px;">
            <p class="m-0 font-weight-bold" style="color: #555;">No Coupon</p>
        </div>

        {% for coupon in activated_coupons %}
            <div class="coupon-item card p-4 m-2 {% if rental_cost < coupon.min_order_value or coupon.expiry_date < today %} disabled {% endif %}"
                 id="coupon-{{ coupon.id }}"
                 data-discount="{{ coupon.discount }}"
                 data-coupon-id="{{ coupon.id }}"
                 style="width: 12rem; height: auto; background-color: #f9fcff; border: 1px solid #007bff;
                        border-radius: 10px; text-align: left; {% if rental_cost < coupon.min_order_value or coupon.expiry_date < today %} opacity: 0.5; {% endif %}">
                <p class="font-weight-bold" style="color: #007bff; font-size: 1.2rem;"><i class="fas fa-tag"></i> £{{ coupon.discount }} Off</p>
                <p style="color: #555;">Code: {{ coupon.code }}</p>
                <p style="font-size: 0.9rem; color: #888;">Min: £{{ coupon.min_order_value }}, Expires: {{ coupon.expiry_date }}</p>
                {% if rental_cost < coupon.min_order_value or coupon.expiry_date < today %}
                    <p class="text-danger" style="font-weight: bold;">Not Eligible</p>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <!-- 支付按钮 -->
    <div class="text-center mb-5">
        <button class="btn btn-primary btn-lg" onclick="payNow()" style="background-color: #007bff; border-color: #007bff;">Pay Now</button>
    </div>
</div>

<script>
    let selectedCouponId = null;
    let originalCost = {{ rental_cost }};

    document.querySelectorAll('.coupon-item').forEach(function (coupon) {
        coupon.addEventListener('click', function () {
            document.querySelectorAll('.coupon-item').forEach(function (item) {
                item.style.backgroundColor = "#f9fcff";
                item.style.color = "#007bff";
            });

            coupon.style.backgroundColor = "rgba(0, 123, 255, 0.3)";
            coupon.style.color = "#002366";
            selectedCouponId = coupon.getAttribute('data-coupon-id');

            const discount = parseFloat(coupon.getAttribute('data-discount'));
            const isEligible = !coupon.querySelector('p.text-danger');

            if (discount > 0 && isEligible) {
                const newCost = originalCost - discount;
                document.getElementById('rental_cost_display').innerHTML = `
                    <strong>Rental Cost:</strong>
                    <span style="text-decoration: line-through; color: #888;">£${originalCost.toFixed(2)}</span>
                    <span id="new_rental_cost" style="font-size: 1.8rem; color: #007bff;">£${newCost.toFixed(2)}</span>`;
            } else {
                document.getElementById('rental_cost_display').innerHTML = `<strong>Rental Cost:</strong> £${originalCost.toFixed(2)}`;
            }
        });
    });

    // 评分模块
    document.addEventListener("DOMContentLoaded", function() {
        const stars = document.querySelectorAll('.star');
        const ratingInput = document.getElementById('rating');

        let currentRating = 5;
        ratingInput.value = currentRating;

        function updateStarColors(ratingValue) {
            stars.forEach(function(star) {
                star.style.color = star.getAttribute('data-value') <= ratingValue ? '#ffc107' : '#ddd';
            });
        }

        updateStarColors(currentRating);

        stars.forEach(function(star) {
            star.addEventListener('click', function() {
                currentRating = this.getAttribute('data-value');
                ratingInput.value = currentRating;
                updateStarColors(currentRating);
            });

            star.addEventListener('mouseover', function() {
                updateStarColors(this.getAttribute('data-value'));
            });

            star.addEventListener('mouseout', function() {
                updateStarColors(currentRating);
            });
        });
    });

    function payNow() {
        const rating = document.getElementById('rating').value;

        fetch("{% url 'return_vehicle' history_id=history_id vehicle_id=vehicle.id %}", {
            method: "POST",
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                'action': 'pay_now',
                'rating': rating,
                'coupon_id': selectedCouponId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message === 'Payment and rating submitted successfully!') {
                alert('Payment and rating submitted successfully! New balance: £' + data.new_balance);
                window.location.href = '/customer/order_page/';
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>

{% endblock %}

